# Telegram Media Server

Telegram Media Server — это Telegram-бот, который принимает ссылки на стриминговое видео или торрент-файлы, загружает их и раздает во внутренней сети через DLNA-сервер (например, `minidlna`).

## Оглавление

- [Особенности](#особенности)
- [Требования](#требования)
- [Установка](#установка)
  - [Установка бота](#установка-бота)
  - [Установка и настройка minidlna](#установка-и-настройка-minidlna)
- [Конфигурация](#конфигурация)
- [Использование](#использование)
  - [Доступные команды](#доступные-команды)
- [Сетевые настройки](#сетевые-настройки)
- [Известные проблемы и ограничения](#известные-проблемы-и-ограничения)
- [Лицензия](#лицензия)

## Особенности

- **Прием ссылок**: Поддерживает все ссылки на видео, которые поддерживаются утилитой `yt-dlp`.
- **Загрузка контента**: Загружает видео и торрент-файлы, отслеживая прогресс загрузки.
- **Раздача во внутренней сети**: Раздает загруженный контент через DLNA-сервер.
- **Управление загрузками**: Позволяет просматривать и управлять текущими загрузками через команды бота.
- **Авторизация пользователей**: Доступ к боту защищен паролем.

## Требования

- **Операционная система**: Arch Linux
- **Архитектуры**: `aarch64`, `armv7h`, `x86_64`
- **Зависимости**:
  - **Для сборки**: `go`
  - **Для выполнения**: `yt-dlp`, `minidlna` (рекомендуется)
- **Прочее**:
  - Установленный и настроенный DLNA-сервер (например, `minidlna`)

## Установка

### Установка бота

1. **Установка пакетa:**

Установите пакет `telegram-media-server` с помощью пакетного менеджера `pacman`:

```bash
sudo pacman -U telegram-media-server.pkg.tar.zst
```

2. **Конфигурация:**

При установке файл примера конфигурации будет скопирован в **/etc/telegram-media-server/.env**. Если файл конфигурации не создан автоматически, скопируйте его вручную:

```bash
sudo cp /etc/telegram-media-server/.env.example /etc/telegram-media-server/.env
```

3. **Редактирование конфигурации:**

Откройте файл **/etc/telegram-media-server/.env** и настройте параметры в соответствии с вашими требованиями.

4. **Запуск сервиса:**

Сервис `telegram-media-server` должен автоматически включиться и запуститься. Если этого не произошло, выполните:

```bash
sudo systemctl enable telegram-media-server
sudo systemctl start telegram-media-server
```

### Установка и настройка minidlna

1. **Установка minidlna:**

```bash
sudo pacman -Sy minidlna
```

2. **Настройка minidlna:**

Отредактируйте файл конфигурации **/etc/minidlna.conf** и настройте следующие параметры:

```conf
media_dir=V,/path/to/dir
friendly_name=My DLNA Server
```

Замените **/path/to/dir** на тот же путь, что указан в параметре **MOVIE_PATH** файла **.env** бота.

3. **Запуск minidlna:**

```bash
sudo systemctl enable minidlna
sudo systemctl start minidlna
```

## Конфигурация

Файл конфигурации бота находится по пути **/etc/telegram-media-server/.env**. Ниже описаны доступные параметры:

* `BOT_TOKEN (обязательно)`: Токен вашего Telegram-бота, полученный от BotFather.
* `MOVIE_PATH`: Путь к директории, где будут храниться база данных, загружаемые файлы и фильмы.
* `PASSWORD`: Пароль для авторизации пользователей в боте. Вход выполняется один раз для каждого чата.
* `UPDATE_INTERVAL_SECONDS`: Интервал в секундах для отправки обновлений о прогрессе загрузки (по умолчанию: `30`).
* `UPDATE_PERCENTAGE_STEP`: Шаг прогресса загрузки в процентах для отправки обновлений (по умолчанию: `20`).
* `MIN_DOWNLOAD_PERCENTAGE`: Минимальный процент загрузки торрента для продолжения загрузки (по умолчанию: `10`).
* `MAX_WAIT_TIME_MINUTES`: Максимальное время в минутах ожидания загрузки минимального процента торрента (по умолчанию: `10`).
* `LANG`: Язык сообщений бота. Поддерживаемые значения: ru, en.

### Пример файла **.env**:

```env
BOT_TOKEN=123456789:ABCDEFghIJKlmnoPQRStuvWXyz
MOVIE_PATH=/media/videos
PASSWORD=MySecretPassword
UPDATE_INTERVAL_SECONDS=30
UPDATE_PERCENTAGE_STEP=20
MIN_DOWNLOAD_PERCENTAGE=10
MAX_WAIT_TIME_MINUTES=10
LANG=en
```

## Использование

### Авторизация

Перед использованием бота необходимо авторизоваться с помощью команды:

```plaintext
/login <password>
```

Где **<password>** — пароль, указанный в параметре **PASSWORD** файла .env.

### Доступные команды

* `/start` — Отображает приветственное сообщение.
* `/login` <password> — Авторизация пользователя в боте.
* `/ls` — Показывает список текущих загрузок и их статус.
* `/rm <id>` — Удаляет загрузку по ID, полученному из команды /ls. Пример: `/rm 2`.
* `/rm all` — Удаляет все текущие загрузки.
* `/stop` — Останавливает все текущие торрент-загрузки.

### Отправка ссылок

После авторизации вы можете отправлять боту ссылки на видео или торрент-файлы.
Бот поддерживает все ссылки, которые обрабатываются утилитой `yt-dlp`.

### Примеры поддерживаемых ссылок:

* YouTube
* VK
* RuTube
* и другие

### Медленные загрузки:

Если торрент-файл не загрузится на минимальный процент (`MIN_DOWNLOAD_PERCENTAGE`) в течение максимального времени ожидания (`MAX_WAIT_TIME_MINUTES`), загрузка будет автоматически остановлена и удалена.
